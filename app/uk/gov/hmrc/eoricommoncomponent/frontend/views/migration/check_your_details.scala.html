@*
 * Copyright 2020 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.eoricommoncomponent.frontend.domain.{CdsOrganisationType, NameIdOrganisationMatchModel}
@import uk.gov.hmrc.eoricommoncomponent.frontend.forms.FormUtils.dateTimeFormat
@import uk.gov.hmrc.eoricommoncomponent.frontend.forms.models.subscription.ContactDetailsModel
@import uk.gov.hmrc.eoricommoncomponent.frontend.forms.models.subscription.AddressViewModel
@import uk.gov.hmrc.eoricommoncomponent.frontend.domain._
@import org.joda.time.LocalDate
@import views.html.helper._
@import uk.gov.hmrc.eoricommoncomponent.frontend.views.html._
@import uk.gov.hmrc.eoricommoncomponent.frontend.views.html.helpers.summaryRow
@import uk.gov.hmrc.eoricommoncomponent.frontend.models.Service


@this(layout_di: layout, summaryRow_di: summaryRow)
@(  isThirdCountrySubscription: Boolean,
        isIndividualSubscriptionFlow: Boolean,
        organisationType: Option[CdsOrganisationType],
        contactDetails: Option[ContactDetailsModel],
        addressDetails: Option[AddressViewModel],
        principalEconomicActivity: Option[String],
        eoriNumber: Option[String],
        email: Option[String],
        nameIdOrganisationDetails: Option[NameIdOrganisationMatchModel],
        nameOrganisationDetails: Option[NameOrganisationMatchModel],
        nameDobDetails: Option[NameDobMatchModel],
        dateEstablished: Option[LocalDate],
        idDetails: Option[IdMatchModel],
        customsId: Option[CustomsId],
        service: Service,
        journey: Journey.Value)(implicit request: Request[_], messages: Messages)


    @labelForEUCountry(countryCode: String) = @{
        messages(messageKeyForEUCountryCode(countryCode))
    }

    @messageKeyForEUCountryCode(countryCode: String) = @{
        s"cds.country.$countryCode"
    }

    @isEUCountryCode(countryCode: String) = @{
        messages.isDefinedAt(messageKeyForEUCountryCode(countryCode))
    }

    @transformCountryCodeToLabel(code: String) = @{
        code match {
            case "GB" => messages("cds.country.GB")
            case c if isEUCountryCode(c) => labelForEUCountry(c)
            case _ => code
        }
    }

    @faxNumberWithPrefix(fax: String) = @{
        s"${messages("cds.review-page.fax-prefix")} $fax"
    }

    @formatDate(date: LocalDate) = @{
        dateTimeFormat.print(date)
    }

    @isSoleTrader = @{
        organisationType.contains(CdsOrganisationType.SoleTrader) || organisationType.contains(CdsOrganisationType.ThirdCountrySoleTrader)
    }

    @isCompany =@{
        organisationType.contains(CdsOrganisationType.Company) && !isThirdCountrySubscription
    }

    @isPartnership = @{
        organisationType.contains(CdsOrganisationType.Partnership) ||
        organisationType.contains(CdsOrganisationType.LimitedLiabilityPartnership)
    }

    @businessDetailsLabel = @{
        if(isIndividualSubscriptionFlow || isSoleTrader) {
            messages("cds.form.contact-details")
        } else if(isPartnership){
            messages("cds.form.partner-address")
        } else if(isCompany) {
            messages("cds.form.company-address")
        } else {
            messages("cds.form.business-details")
        }
    }

    @nameLabel = @{
        if(isPartnership) {
            messages("cds.partnership.name.label")
        } else if(isCompany){
            messages("cds.company.name.label")
        } else {
            messages("cds.organisation.name.label")
        }

    }

    @utrLabel = @{
        if(isIndividualSubscriptionFlow) {
            messages("cds.utr.label")
        } else {
            if(isPartnership) {
                messages("cds.partnership-utr.label")
            } else {
                messages("cds.company.utr.label")
            }
        }
    }
@*Check NameIdModel for UTR, if it exits use that, if it doesn't use CustomsIdModel*@
    @utr = @{
        nameIdOrganisationDetails match {
            case Some(_) => None
            case None => customsId match {
                case u@Some(Utr(_)) => u
                case _ => None
            }
        }
    }

    @nino = @{
        customsId match {
            case n@Some(Nino(_)) => n
            case _ => None
        }
    }

    @addressHtml(ad: AddressViewModel) = {
      @helpers.noMarginParagraph(ad.street)
      @helpers.noMarginParagraph(ad.city)
      @ad.postcode.map(helpers.noMarginParagraph(_))
      @helpers.noMarginParagraph(transformCountryCodeToLabel(ad.countryCode))
    }

    @contactDetailsHtml(cd: ContactDetailsModel) = {
        @helpers.noMarginParagraph(cd.fullName)
        @helpers.noMarginParagraph(cd.telephone)
        @cd.fax.map(fax => helpers.noMarginParagraph(faxNumberWithPrefix(fax)))
        @cd.street.map(helpers.noMarginParagraph(_))
        @cd.city.map(helpers.noMarginParagraph(_))
        @cd.postcode.map(helpers.noMarginParagraph(_))
        @cd.countryCode.map(code => helpers.noMarginParagraph(transformCountryCodeToLabel(code)))
    }

    @layout_di(messages("cds.form.check-answers")) {

        <div class="column-two-thirds">
            <header>
                <h1 class="heading-large">@messages("cds.form.check-answers")</h1>
            </header>

            <dl id="review-tbl" class="govuk-check-your-answers cya-questions-short">
                @summaryRow_di(
                    "email",
                    messages("subscription.enter-email.label"),
                    Html.apply(email.getOrElse("")),
                    None
                )
                @summaryRow_di(
                    "eori-number",
                    messages("cds.subscription.enter-eori-number.eori-number.label"),
                    Html.apply(eoriNumber.getOrElse("")),
                    Some(uk.gov.hmrc.eoricommoncomponent.frontend.controllers.subscription.routes.WhatIsYourEoriController.reviewForm(service, journey)),
                    messages("cds.subscription.enter-eori-number.eori-number.label")
                )
                @nameOrganisationDetails.map { d =>
                    @if(isThirdCountrySubscription) {
                        @summaryRow_di(
                            "org_name",
                            nameLabel,
                            Html.apply(d.name),
                            Some(uk.gov.hmrc.eoricommoncomponent.frontend.controllers.migration.routes.NameOrgController.reviewForm(service, journey)),
                            nameLabel
                        )
                    }
                }
                @nameDobDetails.map { nd =>
                    @summaryRow_di(
                        "full-name",
                        messages("subscription.check-your-details.full-name.label"),
                        Html.apply(s"${nd.firstName} ${nd.lastName}"),
                        Some(uk.gov.hmrc.eoricommoncomponent.frontend.controllers.migration.routes.NameDobSoleTraderController.reviewForm(service, journey)),
                        messages("subscription.check-your-details.full-name.label")
                    )
                    @summaryRow_di(
                        "date-of-birth",
                        messages("subscription.check-your-details.date-of-birth.label"),
                        Html.apply(formatDate(nd.dateOfBirth)),
                        Some(uk.gov.hmrc.eoricommoncomponent.frontend.controllers.migration.routes.NameDobSoleTraderController.reviewForm(service, journey)),
                        messages("subscription.check-your-details.date-of-birth.label")
                    )
                }
                @nino.map { n =>
                    @summaryRow_di(
                        "nino",
                        messages("cds.nino.label"),
                        Html.apply(n.id),
                        if(!isThirdCountrySubscription) Some(uk.gov.hmrc.eoricommoncomponent.frontend.controllers.registration.routes.HowCanWeIdentifyYouController.reviewForm(service, journey)) else None,
                        messages("cds.nino.label")
                    )
                }
                @utr.map { u =>
                    @summaryRow_di(
                        "utr",
                        messages("cds.utr.label"),
                        Html.apply(u.id),
                        if(!isThirdCountrySubscription) Some(uk.gov.hmrc.eoricommoncomponent.frontend.controllers.registration.routes.HowCanWeIdentifyYouController.reviewForm(service, journey)) else None,
                        messages("cds.utr.label")
                    )
                }
                @nameIdOrganisationDetails.map { n =>
                    @if(!isThirdCountrySubscription){
                        @summaryRow_di(
                            "orgname",
                            nameLabel,
                            Html.apply(n.name),
                            Some(uk.gov.hmrc.eoricommoncomponent.frontend.controllers.migration.routes.NameIDOrgController.reviewForm(service, journey)),
                            nameLabel
                        )
                    }
                    @summaryRow_di(
                        "utr",
                        utrLabel,
                        Html.apply(n.id),
                        if(!isThirdCountrySubscription) Some(uk.gov.hmrc.eoricommoncomponent.frontend.controllers.migration.routes.NameIDOrgController.reviewForm(service, journey)) else None,
                        utrLabel
                    )
                }
                @addressDetails.map { ad =>
                    @summaryRow_di(
                        "name-and-address",
                        businessDetailsLabel,
                        addressHtml(ad),
                        Some(uk.gov.hmrc.eoricommoncomponent.frontend.controllers.routes.AddressController.reviewForm(service, journey)),
                        businessDetailsLabel
                    )
                }
                @contactDetails.map { cd =>
                    @summaryRow_di(
                        "contact-details",
                        messages("cds.form.customs-contact"),
                        contactDetailsHtml(cd),
                        Some(uk.gov.hmrc.eoricommoncomponent.frontend.controllers.subscription.routes.ContactDetailsController.reviewForm(service, journey)),
                        messages("cds.form.customs-contact")
                    )
                }
                @dateEstablished.map { de =>
                    @summaryRow_di(
                        "date-established",
                        messages("cds.date-established.label"),
                        Html.apply(formatDate(de)),
                        Some(uk.gov.hmrc.eoricommoncomponent.frontend.controllers.subscription.routes.DateOfEstablishmentController.reviewForm(service, journey)),
                        messages("cds.date-established.label")
                    )

                }

            </dl>

            <p class="govuk-body mt-2">@messages("cds.form.disclaimer")</p>

            <div class="form-group">
                @helper.form(uk.gov.hmrc.eoricommoncomponent.frontend.controllers.registration.routes.RegisterWithEoriAndIdController.registerWithEoriAndId(service, journey)) {
                    @CSRF.formField

                    <p><input class="button" type="submit" value="@messages("cds.form.send")"></p>
                }

                @helpers.helpAndSupport()
            </div>
        </div>
    }

